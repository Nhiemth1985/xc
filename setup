#!/bin/sh
#
# setup
# 
# Author: MÃ¡rcio Pessoa <marcio.pessoa@sciemon.com>
# Contributors: none
# 
# Description:
#   Install or upgrade xC software on device.
# 
# Example: 
#   setup install /opt/sciemon/xc
#   setup install user@computer:/opt/sciemon/xc
#   setup update /opt/sciemon/xc
#   setup update user@computer:/opt/sciemon/xc
# 
# Change log:
# 2018-05-10
#         * Fixed: Some user output messages.
#         * Changed: Default output of some commands was suppressed.
#
# 2017-06-14
#         * Added: Python-termcolor python-sh as system dependencies.
#         * Added: TrueType font configuration.
#         * Added: Configuration to /usr/share/xsessions/xc.desktop file.
#         * Added: Auto login configuration to file 
#                  /usr/share/lightdm/lightdm.conf.d/60-lightdm-gtk-greeter.conf
# 
# 2016-05-28
#         * Scrash version.
#

readonly ACTION=$1
readonly DESTINATION=$2

message() {
  message=$1
  echo "$message""... \c"
}

check_return() {
  return=$1
  if [ "$return" -eq 0 ]; then
    echo "Done."
  else
    echo "Fail."
    exit 1
  fi
}

install() {
  # Dependencies
  message "Installing software dependencies"
  apt update >/dev/null 2>&1
  apt -y install \
    python-serial \
    python-pygame \
    python-termcolor \
    python-sh \
    python-psutil \
    >/dev/null 2>&1
  check_return $?
  # Copy files
  message "Creating directory structure"
  mkdir -p /opt/sciemon/xc
  check_return $?
  message "Setting user permissions"
  chown --recursive "$USER". /opt/sciemon
  check_return $?
  update
  # Fonts
  mkdir -p ~/.fonts
  ln -s /opt/sciemon/xc/fonts/Digirtu_.ttf ~/.fonts >/dev/null 2>&1
  # Configuration file
  # message "Copying configuration file"
  ln -s /opt/sciemon/xc/devices.json "$HOME"/.devices.json >/dev/null 2>&1
  # check_return $?
  #
  # sh -c 'cat > /usr/share/xsessions/xc.desktop'
# [Desktop Entry]
# Type=Application
# Exec=/opt/sciemon/xc/xc
# Name=xC
# Comment=Axes Controller

  #
  # sh -c 'cat >> /usr/share/lightdm/lightdm.conf.d/60-lightdm-gtk-greeter.conf'
# autologin-user=srackham"
}

update() {
  message "Copying files"
  rsync --include-from rsync_include.txt \
        --exclude-from rsync_exclude.txt \
        --delete --archive ./ \
        /opt/sciemon/xc
  check_return $?
}

case "$ACTION" in
  'install')
    install
    ;;
  'update')
    update
    ;;
  *)
    echo "Usage:
setup install
setup update
"
    exit 1
    ;;
esac
exit 0
